webpackJsonp([12],{3295:function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e){return Math.min(750,Math.max(e,250))}Object.defineProperty(t,"__esModule",{value:!0});var l=n(0),s=n.n(l),d=n(25),c=n.n(d),m=n(19),p=n.n(m),u=n(200),f=n.n(u),h=n(150),y=n.n(h),g=n(316),v=n.n(g),b=n(204),x=n.n(b),w=n(314),E=n.n(w),C=n(73),k=n.n(C),T=n(734),S=n.n(T),_=n(3486),O=n(313),F=n(112),P=n(83),z=n(244),N=n(202),R=n(4245),j=(n.n(R),function(){function e(e,t){var n=[],a=!0,i=!1,r=void 0;try{for(var o,l=e[Symbol.iterator]();!(a=(o=l.next()).done)&&(n.push(o.value),!t||n.length!==t);a=!0);}catch(e){i=!0,r=e}finally{try{!a&&l.return&&l.return()}finally{if(i)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}()),A=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),H=/<input.*?\/>/gi,I=/id="(\w*?)-(\w*?)-val"/,D=/dataelementid="(\w{11})"/,L=/indicatorid="(\w{11})"/,M={heading:{paddingBottom:18},formContainer:{},formPaper:{width:"100%",margin:"0 auto 2rem",padding:"1px 4rem 4rem",position:"relative"},formSection:{marginTop:28},cancelButton:{marginLeft:"2rem"},deleteButton:{marginLeft:"2rem"},paletteHeader:{},paletteFilter:{position:"absolute",top:-16,width:"100%",padding:"8px 8px 16px"},paletteFilterField:{width:"100%"},greySwitch:{position:"absolute",bottom:8,left:8,right:8}},W=function(e){function t(e,n){a(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r.state={usedIds:[],filter:"",paletteWidth:o(window.innerWidth/3),expand:"data_elements",insertGrey:!1},Promise.all([n.d2.models.dataSets.get(e.params.modelId,{fields:"id,displayName,dataEntryForm[id,style,htmlCode],indicators[id,displayName]"}),n.d2.Api.getApi().get("dataElementOperands",{paging:!1,totals:!0,fields:"id,dimensionItem,displayName",dataSet:e.params.modelId}),n.d2.Api.getApi().get("system/flags")]).then(function(e){var t=j(e,3),n=t[0],a=t[1],i=t[2];r.operands=a.dataElementOperands.filter(function(e){return-1!==e.dimensionItem.indexOf(".")}).reduce(function(e,t){return e[t.dimensionItem.split(".").join("-")+"-val"]=t.displayName,e},{}),r.totals=a.dataElementOperands.filter(function(e){return-1===e.dimensionItem.indexOf(".")}).reduce(function(e,t){return e[t.id]=t.displayName,e},{}),r.indicators=n.indicators.toArray().sort(function(e,t){return e.displayName.localeCompare(t.displayName)}).reduce(function(e,t){return e[t.id]=t.displayName,e},{}),r.flags=i.reduce(function(e,t){return e[t.path]=t.name,e},{}),r.insertFn={},Object.keys(r.operands).forEach(function(e){r.insertFn[e]=r.insertElement.bind(r,e)}),Object.keys(r.totals).forEach(function(e){r.insertFn[e]=r.insertElement.bind(r,e)}),Object.keys(r.indicators).forEach(function(e){r.insertFn[e]=r.insertElement.bind(r,e)}),Object.keys(r.flags).forEach(function(e){r.insertFn[e]=r.insertFlag.bind(r,e)}),r.filterAction=F.a.create("filter"),r.filterAction.map(function(e){var t=e.data,n=e.complete,a=e.error;return{data:t[1],complete:n,error:a}}).debounceTime(75).subscribe(function(e){var t=e.data.split(" ").filter(function(e){return e.length});r.setState({filter:t})});var o=n.dataEntryForm?r.processFormData(n.dataEntryForm):"";r.setState({formTitle:n.displayName,formHtml:o,formStyle:n.dataEntryForm&&n.dataEntryForm.style||"NORMAL"},function(){r._editor=window.CKEDITOR.replace("designTextarea",{plugins:["a11yhelp","basicstyles","bidi","blockquote","clipboard","colorbutton","colordialog","contextmenu","dialogadvtab","div","elementspath","enterkey","entities","filebrowser","find","floatingspace","font","format","horizontalrule","htmlwriter","image","indentlist","indentblock","justify","link","list","liststyle","magicline","maximize","forms","pastefromword","pastetext","preview","removeformat","resize","selectall","showblocks","showborders","sourcearea","specialchar","stylescombo","tab","table","tabletools","toolbar","undo","wsc","wysiwygarea"].join(","),removePlugins:"scayt,wsc,about",allowedContent:!0,extraPlugins:"div",height:500}),r._editor.setData(r.state.formHtml),c.a.Observable.fromEventPattern(function(e){r._editor.on("change",e)}).debounceTime(250).subscribe(function(){r.processFormData.call(r,r._editor.getData())})})}),r.getTranslation=r.context.d2.i18n.getTranslation.bind(r.context.d2.i18n),r.handleSaveClick=r.handleSaveClick.bind(r),r.handleCancelClick=r.handleCancelClick.bind(r),r.handleDeleteClick=r.handleDeleteClick.bind(r),r.handleStyleChange=r.handleStyleChange.bind(r),r.startResize=r.startResize.bind(r),r.doResize=r.doResize.bind(r),r.endResize=r.endResize.bind(r),r}return r(t,e),A(t,[{key:"componentWillUnmount",value:function(){this._editor&&this._editor.destroy()}},{key:"handleSaveClick",value:function(){var e=this,t={style:this.state.formStyle,htmlCode:this._editor.getData()};this.context.d2.Api.getApi().post(["dataSets",this.props.params.modelId,"form"].join("/"),t).then(function(){p.a.info("Form saved successfully"),P.a.show({message:e.getTranslation("form_saved")}),n.i(N.a)("list/dataSetSection/dataSet")}).catch(function(t){p.a.warn("Failed to save form:",t),P.a.show({message:e.getTranslation("failed_to_save_form")+(t.message?": "+t.message:""),action:e.context.d2.i18n.getTranslation("ok")})})}},{key:"handleCancelClick",value:function(){n.i(N.a)("list/dataSetSection/dataSet")}},{key:"handleDeleteClick",value:function(){var e=this;P.a.show({message:this.getTranslation("dataentryform_confirm_delete"),action:"confirm",onActionTouchTap:function(){e.context.d2.Api.getApi().delete(["dataEntryForms",z.a.state.dataEntryForm.id].join("/")).then(function(){P.a.show({message:e.getTranslation("form_deleted")}),n.i(N.a)("list/dataSetSection/dataSet")}).catch(function(t){p.a.error("Failed to delete form:",t),P.a.show({message:e.getTranslation("failed_to_delete_form"),action:"ok"})})}})}},{key:"handleStyleChange",value:function(e,t,n){this.setState({formStyle:n})}},{key:"startResize",value:function(e){this._startPos=e.clientX,this._startWidth=this.state.paletteWidth,window.addEventListener("mousemove",this.doResize),window.addEventListener("mouseup",this.endResize)}},{key:"doResize",value:function(e){var t=this;e.buttons||this.endResize(),e.preventDefault(),e.stopPropagation();var n=o(this._startWidth+(this._startPos-e.clientX));window.requestAnimationFrame(function(){t.setState({paletteWidth:n})})}},{key:"endResize",value:function(){window.removeEventListener("mousemove",this.doResize),window.removeEventListener("mouseup",this.endResize)}},{key:"generateHtml",value:function(e,t,n){var a=t?" style="+t:"",i=n||this.state.insertGrey?' disabled="disabled"':"";if(-1!==e.indexOf("-")){var r=this.operands&&this.operands[e];return'<input id="'+e+'" '+('name="entryfield" title="'+r+'" value="[ '+r+' ]"'+a+i).trim()+"/>"}if(this.totals.hasOwnProperty(e)){var o=this.totals[e];return'<input dataelementid="'+e+'" id="total'+e+'" name="total" '+('name="total" readonly title="'+o+'" value="[ '+o+' ]"'+a+i).trim()+"/>"}if(this.indicators.hasOwnProperty(e)){var l=this.indicators[e];return'<input indicatorid="'+e+'" id="indicator'+e+'" '+('name="indicator" readonly title="'+l+'" value="[ '+l+' ]"'+a+i).trim()+"/>"}return p.a.warn("Failed to generate HTML for ID:",e),""}},{key:"processFormData",value:function(e){for(var t=e.hasOwnProperty("htmlCode")?e.htmlCode:e||"",n="",a=[],i=H.exec(t),r=0;null!==i;){n+=t.substr(r,i.index-r),r=H.lastIndex;var o=i[0],l=(/style="(.*?)"/.exec(o)||["",""])[1],s=null!==/disabled/.exec(o),d=I.exec(o),c=D.exec(o),m=L.exec(o);if(d){var p=d[1]+"-"+d[2]+"-val";a.push(p),n+=this.generateHtml(p,l,s)}else if(c){var u=c[1];a.push(u),n+=this.generateHtml(u,l,s)}else if(m){var f=m[1];a.push(f),n+=this.generateHtml(f,l,s)}else n+=o;i=H.exec(t)}return n+=t.substr(r),this.setState({usedIds:a}),n}},{key:"insertElement",value:function(e){if(-1===this.state.usedIds.indexOf(e)){this._editor.insertHtml(this.generateHtml(e),"unfiltered_html"),this.setState(function(t){return{usedIds:t.usedIds.concat(e)}});var t=this._editor.getSelection().getRanges()[0];t.moveToElementEditablePosition(t.endContainer,!0)}}},{key:"insertFlag",value:function(e){this._editor.insertHtml('<img src="../dhis-web-commons/flags/'+e+'" />',"unfiltered_html");var t=this._editor.getSelection().getRanges()[0];t.moveToElementEditablePosition(t.endContainer,!0)}},{key:"renderPaletteSection",value:function(e,t){var n=this,a=Object.keys(e).filter(function(t){return!n.state.filter.length||n.state.filter.every(function(n){return-1!==e[t].toLowerCase().indexOf(n.toLowerCase())})}),i=t===this.state.expand?"cell expanded":"cell",r=function(){n.setState({expand:t})};return s.a.createElement("div",{className:i},s.a.createElement("div",{style:M.paletteHeader,className:"header",onClick:r},s.a.createElement("div",{className:"arrow"},"â–¸"),this.getTranslation(t),":",s.a.createElement("div",{className:"count"},a.length)),s.a.createElement("div",{className:"items"},a.sort(function(t,n){return e[t]?e[t].localeCompare(e[n]):t.localeCompare(n)}).map(function(t){var a=-1===n.state.usedIds.indexOf(t),i=a?"item active":"item inactive",r=e[t].name||e[t];return s.a.createElement("div",{key:t,className:i,title:r},s.a.createElement("a",{onClick:n.insertFn[t]},r))})))}},{key:"renderPalette",value:function(){var e=this,t=function(t,n){e.setState({insertGrey:n})};return s.a.createElement("div",{className:"paletteContainer",style:{width:this.state.paletteWidth}},s.a.createElement("div",{className:"resizeHandle",onMouseDown:this.startResize}),s.a.createElement("div",{className:"palette"},s.a.createElement("div",{style:M.paletteFilter},s.a.createElement(k.a,{floatingLabelText:this.getTranslation("filter_elements"),style:M.paletteFilterField,onChange:this.filterAction})),s.a.createElement("div",{className:"elements"},this.renderPaletteSection(this.operands,"data_elements"),this.renderPaletteSection(this.totals,"totals"),this.renderPaletteSection(this.indicators,"indicators"),this.renderPaletteSection(this.flags,"flags")),s.a.createElement(S.a,{label:this.getTranslation("insert_grey_fields"),labelPosition:"right",style:M.greySwitch,onCheck:t,checked:this.state.insertGrey})))}},{key:"render",value:function(){return void 0===this.state.formHtml?s.a.createElement(_.a,null):s.a.createElement("div",{style:Object.assign({},M.formContainer,{marginRight:this.state.paletteWidth})},s.a.createElement(O.a,{style:M.heading},this.state.formTitle," ",this.getTranslation("data_entry_form")),this.renderPalette(),s.a.createElement("textarea",{id:"designTextarea",name:"designTextarea"}),s.a.createElement(E.a,{style:M.formPaper},s.a.createElement("div",{style:M.formSection},s.a.createElement(v.a,{value:this.state.formStyle,floatingLabelText:"Form display style",onChange:this.handleStyleChange},s.a.createElement(x.a,{value:"NORMAL",primaryText:this.getTranslation("normal")}),s.a.createElement(x.a,{value:"COMFORTABLE",primaryText:this.getTranslation("comfortable")}),s.a.createElement(x.a,{value:"COMPACT",primaryText:this.getTranslation("compact")}),s.a.createElement(x.a,{value:"NONE",primaryText:this.getTranslation("none")}))),s.a.createElement("div",{style:M.formSection},s.a.createElement(f.a,{label:this.getTranslation("save"),primary:!0,onClick:this.handleSaveClick}),s.a.createElement(y.a,{label:this.getTranslation("cancel"),style:M.cancelButton,onClick:this.handleCancelClick}),z.a.state.dataEntryForm&&z.a.state.dataEntryForm.id?s.a.createElement(y.a,{primary:!0,label:this.getTranslation("delete"),style:M.deleteButton,onClick:this.handleDeleteClick}):void 0)))}}]),t}(s.a.Component);W.propTypes={params:s.a.PropTypes.object},W.contextTypes={d2:s.a.PropTypes.any},t.default=W},3486:function(e,t,n){"use strict";function a(e){var t=e.style,n=void 0===t?{}:t,a=e.large,i=void 0!==a&&a,r=e.small,o=void 0!==r&&r;return l.a.createElement("div",{style:Object.assign({},d,n)},l.a.createElement(s.a,{large:i,small:o}))}t.a=a;var i=n(1),r=n.n(i),o=n(0),l=n.n(o),s=n(167),d={left:"45%",position:"fixed",top:"45%"};a.propTypes={style:r.a.object,large:r.a.bool,small:r.a.bool}},3903:function(e,t,n){t=e.exports=n(451)(!1),t.push([e.i,'.paletteContainer {\n  position: fixed;\n  right: 16px;\n  top: 112px;\n  bottom: 16px;\n}\n.paletteContainer:hover .resizeHandle:after {\n  border-color: rgba(0, 0, 0, 0.12);\n}\n.paletteContainer .resizeHandle {\n  position: absolute;\n  top: -20px;\n  right: 0;\n  bottom: -16px;\n  left: -8px;\n  width: 12px;\n  cursor: col-resize;\n}\n.paletteContainer .resizeHandle:after {\n  content: "";\n  display: block;\n  position: absolute;\n  bottom: 0;\n  top: 0;\n  border: 0 dashed rgba(0, 0, 0, 0);\n  border-left-width: 1px;\n  margin-left: 5px;\n  transition: border 125ms linear;\n}\n.paletteContainer .resizeHandle:hover:after {\n  border-color: rgba(0, 0, 0, 0.45);\n}\n.paletteContainer .palette {\n  position: absolute;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 8px;\n  background: white;\n  border-radius: 5px;\n  box-shadow: 0 1px 6px rgba(0, 0, 0, 0.12), 0 1px 4px rgba(0, 0, 0, 0.12);\n}\n.paletteContainer .palette .elements {\n  position: absolute;\n  top: 48px;\n  bottom: 32px;\n  left: 0;\n  right: 0;\n  margin: 8px;\n  font-size: 13px;\n  font-weight: 300;\n  display: flex;\n  flex-direction: column;\n  overflow-x: auto;\n}\n.paletteContainer .palette .elements .cell {\n  position: relative;\n  flex: 1 1;\n  transition: all 175ms ease-in-out;\n}\n.paletteContainer .palette .elements .cell.expanded {\n  flex: 35;\n}\n.paletteContainer .palette .elements .cell.expanded .header .arrow {\n  transform: rotate(90deg);\n}\n.paletteContainer .palette .elements .cell .header {\n  font-weight: 700;\n  font-size: 16px;\n  padding-top: 8px;\n  cursor: pointer;\n}\n.paletteContainer .palette .elements .cell .header .arrow {\n  display: inline-block;\n  margin: 0 2px;\n  transition: transform 175ms ease-out;\n}\n.paletteContainer .palette .elements .cell .header .count {\n  display: inline-block;\n  font-weight: 400;\n  font-size: 14px;\n  margin-left: 4px;\n}\n.paletteContainer .palette .elements .cell .items {\n  position: absolute;\n  padding-left: 16px;\n  top: 32px;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  overflow: auto;\n}\n.paletteContainer .palette .elements .cell .items .item {\n  width: 100%;\n  padding-bottom: 1px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.item.active a,\n.expand a {\n  cursor: pointer;\n}\n.item.active a:hover,\n.expand a:hover {\n  text-decoration: underline;\n}\n\n.item.inactive a {\n  color: inherit;\n  opacity: 0.5;\n  cursor: default;\n}',""])},4245:function(e,t,n){var a=n(3903);"string"==typeof a&&(a=[[e.i,a,""]]);n(454)(a,{});a.locals&&(e.exports=a.locals)}});
//# sourceMappingURL=12-2036b89eb0327ca434e2.js.map